<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Spell checking in Emacs on Nix-OS - Francis St-Amour</title>
        <script src="../static/jquery.min.js" "></script>
        <link rel=" stylesheet" type="text/css" href="../static/bootstrap.min.css"></script>
        <link rel="stylesheet" type="text/css" href="../static/font-awesome.min.css" />
        <link rel="stylesheet" type="text/css" href="../static/default.css" />
        <link rel="stylesheet" type="text/css" href="../static/syntax.css" />
        <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="../atom.xml">
    </head>
    <body>
        <div id="content">
            <div id="header">
  <a href="../">Home</a>
</div>

<h1>Spell checking in Emacs on Nix-OS</h1>

<div class="info">
    Posted on July 20, 2016
</div>

<p>Hi again, I said in my first post that I wanted to add spell checking to my “writing process”. First reflex, I open Emacs and type <code>M-x ispell</code>. I never used it, but I had a hunch. (I will write this post while I try to set this up).</p>
<p>Being on nix-OS, <code>ispell</code> was not installed because I didn’t asked it to be installed. So I got the message <code>Searching for program: no such file or directory, ispell</code> from Emacs.</p>
<p>Time to Google a little bit, I quickly found <a href="https://www.emacswiki.org/emacs/InteractiveSpell" class="uri">https://www.emacswiki.org/emacs/InteractiveSpell</a> which I read <em>very</em>, <em>very</em> superficially.</p>
<p>Having done “reading”, I decided to install <code>hunspell</code>:</p>
<pre class="shell"><code>nix-env -i hunspell</code></pre>
<p>And installing some dictionaries too:</p>
<pre class="shell"><code>nix-env -i hunspell-dict-fr-moderne-dicollecte hunspell-dict-fr-any-dicollecte hunspell-dict-en-gb-ize-wordlist hunspell-dict-es-cu-rediris</code></pre>
<p>Trying again <code>M-x ispell</code> in Emacs, still got the same error message… Hmm maybe it is literally searching for <code>ispell</code> and nix-OS simply install <code>hunspell</code>.</p>
<p>Back to the terminal, <code>ispell</code> is not found, but <code>hunspell</code> is. Looking at the website again, found the gem <code>(setq ispell-program-name &quot;hunspell&quot;)</code> Eval’d it in Emacs, now I get the error <code>ispell-parse-hunspell-affix-file: ispell-phaf: No matching entry for nil.</code></p>
<p>Thanks to <a href="http://stackoverflow.com/a/29481811">StackOverflow: spell check not working in Emacs text editor</a> (and the <a href="https://www.emacswiki.org/emacs/InteractiveSpell">first site</a>), I eval’d that little piece of s-exp:</p>
<pre class="elisp"><code>(add-to-list 'ispell-local-dictionary-alist '(&quot;english-hunspell&quot;
                                              &quot;[[:alpha:]]&quot;
                                              &quot;[^[:alpha:]]&quot;
                                              &quot;[']&quot;
                                              t
                                              (&quot;-d&quot; &quot;en_US&quot;)
                                              nil
					      UTF-8))</code></pre>
<p>Trying <code>M-x ispell</code> again. Got <code>Starting new Ispell process hunspell with default dictionary... ispell-send-string: Process ispell not running</code>.</p>
<p>My guess was that hunspell wasn’t able to find the dictionary file.</p>
<pre class="shell"><code>[mpsyco@lambda:~]$ hunspell
Can't open affix or dictionary files for dictionary named &quot;en_US&quot;.</code></pre>
<p>Looks like it (and, yes, I named my computer with nix-OS installed on it <em>lambda</em>). It is completely normal that it doesn’t find it since I installed en_GB instead of en_US…</p>
<p>Changing the LANG doesn’t seems to help:</p>
<pre class="shell"><code>[mpsyco@lambda:~]$ export LANG=en_GB

[mpsyco@lambda:~]$ hunspell
Can't open affix or dictionary files for dictionary named &quot;en_GB&quot;.</code></pre>
<p>Here, it took me a while to figure exactly what to do :(</p>
<p>BUT! Thank to <a href="http://comments.gmane.org/gmane.linux.distributions.nixos.scm/29893">this</a> commit, I finally figured where the dictionaries were and how to tell hunspell to search there:</p>
<pre class="shell"><code>[mpsyco@lambda:~]$ export DICPATH=$HOME/.nix-profile/share/hunspell

[mpsyco@lambda:~]$ hunspell -D
SEARCH PATH:
.::/home/mpsyco/.nix-profile/share/hunspell:/usr/share/hunspell:/usr/share/myspell:/usr/share/myspell/dicts:/Library/Spelling:/home/mpsyco/.openoffice.org/3/user/wordbook:.openoffice.org2/user/wordbook:.openoffice.org2.0/user/wordbook:Library/Spelling:/opt/openoffice.org/basis3.0/share/dict/ooo:/usr/lib/openoffice.org/basis3.0/share/dict/ooo:/opt/openoffice.org2.4/share/dict/ooo:/usr/lib/openoffice.org2.4/share/dict/ooo:/opt/openoffice.org2.3/share/dict/ooo:/usr/lib/openoffice.org2.3/share/dict/ooo:/opt/openoffice.org2.2/share/dict/ooo:/usr/lib/openoffice.org2.2/share/dict/ooo:/opt/openoffice.org2.1/share/dict/ooo:/usr/lib/openoffice.org2.1/share/dict/ooo:/opt/openoffice.org2.0/share/dict/ooo:/usr/lib/openoffice.org2.0/share/dict/ooo
AVAILABLE DICTIONARIES (path is not mandatory for -d option):
/home/mpsyco/.nix-profile/share/hunspell/fr-toutesvariantes
/home/mpsyco/.nix-profile/share/hunspell/en_GB-ize
/home/mpsyco/.nix-profile/share/hunspell/es_CU
/home/mpsyco/.nix-profile/share/hunspell/fr-moderne
Can't open affix or dictionary files for dictionary named &quot;en_GB&quot;.</code></pre>
<p>Note to myself: In the future, look into <code>~/.nix-profile/</code> for something installed via <code>nix-env -i</code>.</p>
<p>Good enough, now I can tweak the <code>ispell-local-dictionary-alist</code>:</p>
<pre><code>(setq ispell-local-dictionary-alist '((&quot;english-gb&quot;
                                              &quot;[[:alpha:]]&quot;
                                              &quot;[^[:alpha:]]&quot;
                                              &quot;[']&quot;
                                              t
                                              (&quot;-d&quot; &quot;en_GB-ize&quot;)
                                              nil
					      UTF-8)))</code></pre>
<p><code>M-x ispell</code></p>
<pre><code>Starting new Ispell process hunspell with default dictionary...
Spell-checking ispell.md using hunspell with default dictionary...done
ispell-send-string: Process ispell not running</code></pre>
<p>… Forgot to set the DICPATH environment variable for the <em>still running</em> Emacs!</p>
<p><code>(setenv &quot;DICPATH&quot; &quot;/home/mpsyco/.nix-profile/share/hunspell&quot;)</code></p>
<p>Still not working. Ah, the LANG environment variable is also “not OK”, my computer is actually configured with the “en_US.UTF-8” locale. Better install a “en_US” dictionary to make sure.</p>
<pre class="shell"><code>[mpsyco@lambda:~]$ echo $LANG
en_US.UTF-8

[mpsyco@lambda:~] # Just a small utility that I found on internet
[mpsyco@lambda:~]$ type nix-search
nix-search is a function
nix-search () 
{ 
    echo &quot;Searching...&quot;;
    nix-env -qaP --description '*' | grep -i &quot;$1&quot;
}

[mpsyco@lambda:~]$ nix-search hunspell | fgrep -i us
nixos.hunspellDicts.en-us                                             hunspell-dict-en-us-wordlist-2014.11.17                                       Hunspell dictionary for English (United States) from Wordlist
nixos.mythes                                                          mythes-1.2.4                                                                  Thesaurus library from Hunspell project

[mpsyco@lambda:~]$ nix-env -i hunspell-dict-en-us-wordlist
installing ‘hunspell-dict-en-us-wordlist-2014.11.17’
these paths will be fetched (0.16 MiB download, 0.53 MiB unpacked):
  /nix/store/ffq4kp48xm12mpiaklrk2yp2l491fgfa-hunspell-dict-en-us-wordlist-2014.11.17
fetching path ‘/nix/store/ffq4kp48xm12mpiaklrk2yp2l491fgfa-hunspell-dict-en-us-wordlist-2014.11.17’...

*** Downloading ‘https://cache.nixos.org/nar/1nl4wq5s5n1h1g450rzwxi79xiyqmi8gm8j82wqida9cflaqqicg.nar.xz’ (signed by ‘cache.nixos.org-1’) to ‘/nix/store/ffq4kp48xm12mpiaklrk2yp2l491fgfa-hunspell-dict-en-us-wordlist-2014.11.17’...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  159k  100  159k    0     0   365k      0 --:--:-- --:--:-- --:--:--  364k

building path(s) ‘/nix/store/793l0bjhlq2ffm7jkx5p891b7gbps28i-user-environment’
created 4355 symlinks in user environment</code></pre>
<p>Now, hunspell works out of the box in the shell:</p>
<pre class="shell"><code>[mpsyco@lambda:~]$ hunspell
Hunspell 1.3.3
^C</code></pre>
<p>And drum roll….</p>
<p><code>M-x ispell</code></p>
<pre><code>Starting new Ispell process hunspell with default dictionary...
Spell-checking ispell.md using hunspell with default dictionary...
Spell-checking suspended; use C-u z = to resume</code></pre>
<p>Oh yeah! Now I [can] have spell checking everywhere in Emacs.</p>
<p>But, I’m not done yet, I want to make sure it will works the next time I open Emacs.</p>
<p>Adding</p>
<pre><code>export DICPATH=&quot;$HOME/.nix-profile/share/hunspell:$DICPATH&quot;</code></pre>
<p>Into my <code>~/.profile</code>.</p>
<p>Opening Emacs in a new terminal:</p>
<script type="text/javascript" src="https://asciinema.org/a/cqebb1bylw9nyq0rbbq6spmh9.js" id="asciicast-cqebb1bylw9nyq0rbbq6spmh9" async></script>
<p>Looks all good!</p>
<p>The funny thing is that, in the end, I didn’t have to tweak my Emacs’ configurations <em>at all</em>, not <code>ispell-local-dictionary-alist</code>, nor <code>ispell-program-name</code>, not even a little <code>(setenv ...)</code>. Which means they were all red-hearing that could probably have been avoided with better error reporting from Emacs. But as I keep finding out on nix-OS, people don’t seem to be good at reporting this kind of thing. <a href="https://github.com/roswell/roswell/issues/151">Here</a> is one example, it was a program (that I tried on Windows) that tried to start Emacs, but spewed around 30 lines of backtrace when it wasn’t found.</p>
<p>One last note, the last post was written with Vim in a terminal, this one was written within Emacs. Unfortunately Emacs didn’t colored the markdown out of the box which is reaaally annoying when re-reading the whole thing, or when seeking for something.</p>

<hr />

        </div>
        <div id="footer">
          <div class="right">
            Site source is at <a href="https://github.com/mpsyco/mpsyco.github.com">GitHub</a>,
            and uses <a href="http://jaspervdj.be/hakyll">Hakyll</a>.
          </div>
        </div>
    </body>
</html>
